<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App - HTMX</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>

</head>
<body>
    <h1>Todo Application (HTMX)</h1>

    <hr>

    <!-- Two-Column Layout -->
    <div style="display: flex; gap: 20px;">
        <!-- Left Column: Tabs and Todo List -->
        <div style="flex: 1;">
            <h2>My Todos</h2>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 10px; align-items: center;">
                <a href="#" onclick="switchTab('pending'); return false;" style="padding: 5px 10px; border: 1px solid #ccc; text-decoration: none; cursor: pointer;">Pending Todos</a>
                <a href="#" onclick="switchTab('completed'); return false;" style="padding: 5px 10px; border: 1px solid #ccc; text-decoration: none; cursor: pointer;">Completed Todos</a>
                <a href="#" onclick="switchTab('all'); return false;" style="padding: 5px 10px; border: 1px solid #ccc; text-decoration: none; cursor: pointer;">All Todos</a>
                <a href="#" onclick="switchTab('stats'); return false;" style="padding: 5px 10px; border: 1px solid #ccc; text-decoration: none; cursor: pointer;">Statistics</a>
                <button onclick="toggleCreateForm()" style="margin-left: auto;">+ Create Todo</button>
            </div>

            <hr>

            <!-- Todos List -->
            <div id="todos-list"
                 hx-get="http://localhost:8000/todos/?limit=100"
                 hx-trigger="load, todoUpdated from:body"
                 hx-swap="innerHTML">
                <p>Loading todos...</p>
            </div>

            <!-- Statistics Section -->
            <div id="stats"
                 hx-get="http://localhost:8000/stats"
                 hx-trigger="load, todoUpdated from:body"
                 hx-swap="innerHTML"
                 style="display: none;">
                <h3>Statistics</h3>
                <p>Loading stats...</p>
            </div>
        </div>

        <!-- Right Column: Todo Detail Panel -->
        <div style="flex: 1;">
            <h2>Todo Details</h2>
            <div id="detail-panel">
                <p>Select a todo to view details</p>
            </div>
        </div>
    </div>

    <script>
        // Template for rendering todos
        htmx.on('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'todos-list') {
                const todos = JSON.parse(event.detail.xhr.responseText);
                const html = renderTodos(todos);
                event.detail.target.innerHTML = html;
                htmx.process(event.detail.target);
            } else if (event.detail.target.id === 'stats') {
                const stats = JSON.parse(event.detail.xhr.responseText);
                const html = renderStats(stats);
                event.detail.target.innerHTML = html;
                htmx.process(event.detail.target);
            }
        });

        let currentTab = 'pending';
        let allTodos = [];

        function groupTodosByMonth(todos) {
            // Filter based on current tab
            let filteredTodos = todos;
            if (currentTab === 'pending') {
                filteredTodos = todos.filter(t => !t.completed);
            } else if (currentTab === 'completed') {
                filteredTodos = todos.filter(t => t.completed);
            }

            // Group by month (YYYY-MM format)
            const grouped = {};
            filteredTodos.forEach(todo => {
                let dateStr = todo.due_date ? new Date(todo.due_date).toISOString().slice(0, 7) : 'no-date';
                if (!grouped[dateStr]) {
                    grouped[dateStr] = [];
                }
                grouped[dateStr].push(todo);
            });

            return grouped;
        }

        function formatMonthYear(dateStr) {
            if (dateStr === 'no-date') return 'No Due Date';
            const [year, month] = dateStr.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleString('default', { month: 'long', year: 'numeric' });
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toISOString().slice(0, 10);
        }

        function renderTodos(todos) {
            allTodos = todos;

            const grouped = groupTodosByMonth(todos);
            if (Object.keys(grouped).length === 0) {
                return '<p>No todos found.</p>';
            }

            let html = '';
            const sortedMonths = Object.keys(grouped).sort().reverse();

            sortedMonths.forEach(month => {
                const monthTodos = grouped[month];
                html += `<h3>${formatMonthYear(month)}</h3><div>`;

                monthTodos.forEach(todo => {
                    const dateStr = todo.due_date ? formatDate(todo.due_date) : '????-??-??';
                    const checkedStatus = todo.completed ? 'checked' : '';

                    html += `
                        <div style="padding: 5px; margin: 5px 0; border-bottom: 1px solid #ccc;">
                            <input type="checkbox" ${checkedStatus}
                                   onchange="toggleTodo(${todo.id}, this)"
                                   hx-post="http://localhost:8000/todos/${todo.id}/toggle"
                                   hx-swap="none"
                                   hx-on::after-request="htmx.trigger('body', 'todoUpdated')">
                            <span style="margin-left: 5px; cursor: pointer;" onclick="showTodoDetail(${todo.id})">
                                [${dateStr}] ${todo.title}
                            </span>
                        </div>
                    `;
                });

                html += '</div>';
            });

            return html;
        }

        function renderStats(stats) {
            return `
                <h2>Statistics</h2>
                <p><strong>Total Todos:</strong> ${stats.total}</p>
                <p><strong>Completed:</strong> ${stats.completed}</p>
                <p><strong>Pending:</strong> ${stats.pending}</p>
                <p><strong>Priority Breakdown:</strong></p>
                <ul>
                    <li>Low: ${stats.by_priority.low}</li>
                    <li>Medium: ${stats.by_priority.medium}</li>
                    <li>High: ${stats.by_priority.high}</li>
                </ul>
            `;
        }

        function switchTab(tab) {
            const todosList = document.getElementById('todos-list');
            const statsList = document.getElementById('stats');
            const detailPanel = document.getElementById('detail-panel');

            if (tab === 'stats') {
                // Hide todos list, show stats
                todosList.style.display = 'none';
                statsList.style.display = 'block';
                detailPanel.innerHTML = '<p>Select a statistic or use the tabs to view todos</p>';
            } else {
                // Show todos list, hide stats
                todosList.style.display = 'block';
                statsList.style.display = 'none';

                currentTab = tab;
                const grouped = groupTodosByMonth(allTodos);
                const html = Object.keys(grouped).length === 0 ? '<p>No todos found.</p>' : '';

                if (html) {
                    todosList.innerHTML = html;
                } else {
                    const sortedMonths = Object.keys(grouped).sort().reverse();
                    let result = '';
                    sortedMonths.forEach(month => {
                        const monthTodos = grouped[month];
                        result += `<h3>${formatMonthYear(month)}</h3><div>`;

                        monthTodos.forEach(todo => {
                            const dateStr = todo.due_date ? formatDate(todo.due_date) : '????-??-??';
                            const checkedStatus = todo.completed ? 'checked' : '';

                            result += `
                                <div style="padding: 5px; margin: 5px 0; border-bottom: 1px solid #ccc;">
                                    <input type="checkbox" ${checkedStatus}
                                           onchange="toggleTodo(${todo.id}, this)"
                                           hx-post="http://localhost:8000/todos/${todo.id}/toggle"
                                           hx-swap="none"
                                           hx-on::after-request="htmx.trigger('body', 'todoUpdated')">
                                    <span style="margin-left: 5px; cursor: pointer;" onclick="showTodoDetail(${todo.id})">
                                        [${dateStr}] ${todo.title}
                                    </span>
                                </div>
                            `;
                        });

                        result += '</div>';
                    });
                    todosList.innerHTML = result;
                    htmx.process(todosList);
                }
            }
        }

        function showTodoDetail(id) {
            const todo = allTodos.find(t => t.id === id);
            if (!todo) return;

            const dueDate = todo.due_date ? new Date(todo.due_date).toLocaleString() : 'No due date';
            const createdAt = new Date(todo.created_at).toLocaleString();

            const html = `
                <div>
                    <h3>${todo.title}</h3>
                    <p><strong>Status:</strong> ${todo.completed ? '✓ Completed' : '○ Pending'}</p>
                    <p><strong>Priority:</strong> ${todo.priority.toUpperCase()}</p>
                    <p><strong>Description:</strong> ${todo.description || 'No description'}</p>
                    <p><strong>Due Date:</strong> ${dueDate}</p>
                    <p><strong>Created:</strong> ${createdAt}</p>
                    <div>
                        <button hx-post="http://localhost:8000/todos/${todo.id}/toggle"
                                hx-swap="none"
                                hx-on::after-request="htmx.trigger('body', 'todoUpdated')">
                            ${todo.completed ? 'Mark Pending' : 'Mark Complete'}
                        </button>
                        <button onclick="openEditModal(${todo.id}, ${JSON.stringify(todo).replace(/"/g, '&quot;')})">
                            Edit
                        </button>
                        <button hx-delete="http://localhost:8000/todos/${todo.id}"
                                hx-confirm="Are you sure you want to delete this todo?"
                                hx-swap="none"
                                hx-on::after-request="htmx.trigger('body', 'todoUpdated')">
                            Delete
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('detail-panel').innerHTML = html;
            htmx.process(document.getElementById('detail-panel'));
        }

        function toggleTodo(id, checkbox) {
            // The HTMX request is handled by the attributes on the checkbox
            // This function is just for UI feedback
        }

        function toggleCreateForm() {
            const form = document.getElementById('create-form');
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }

        function openEditModal(id, todoData) {
            const todo = typeof todoData === 'string' ? JSON.parse(todoData) : todoData;

            const modal = document.getElementById('editModal');
            document.getElementById('editId').value = todo.id;
            document.getElementById('editTitle').value = todo.title;
            document.getElementById('editDescription').value = todo.description || '';
            document.getElementById('editPriority').value = todo.priority;
            document.getElementById('editDueDate').value = todo.due_date ? todo.due_date.slice(0, 16) : '';
            document.getElementById('editCompleted').checked = todo.completed;

            modal.style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
    </script>

    <hr>

    <!-- Create Todo Form -->
    <div id="create-form" style="display: none;">
        <h2>Create New Todo</h2>
        <form hx-post="http://localhost:8000/todos/"
              hx-ext="json-enc"
              hx-on::after-request="if(event.detail.successful) this.reset(); htmx.trigger('#todos-list', 'todoUpdated'); htmx.trigger('#stats', 'todoUpdated');"
              hx-swap="none">
        <div>
            <label>Title:</label><br>
            <input type="text" name="title" required>
        </div>
        <div>
            <label>Description:</label><br>
            <textarea name="description" rows="3"></textarea>
        </div>
        <div>
            <label>Priority:</label><br>
            <select name="priority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
            </select>
        </div>
        <div>
            <label>Due Date:</label><br>
            <input type="datetime-local" id="dueDate">
        </div>
        <button type="submit">Create Todo</button>
        </form>
    </div>

    <hr>

    <!-- Edit Modal -->
    <div id="editModal" style="display:none; border: 2px solid black; padding: 20px; margin-top: 20px;">
        <h2>Edit Todo</h2>
        <form hx-patch="" 
              hx-swap="none"
              hx-on::after-request="if(event.detail.successful) { closeEditModal(); htmx.trigger('body', 'todoUpdated'); }"
              id="editForm">
            <input type="hidden" id="editId">
            <div>
                <label>Title:</label><br>
                <input type="text" id="editTitle" name="title" required>
            </div>
            <div>
                <label>Description:</label><br>
                <textarea id="editDescription" name="description" rows="3"></textarea>
            </div>
            <div>
                <label>Priority:</label><br>
                <select id="editPriority" name="priority">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div>
                <label>Due Date:</label><br>
                <input type="datetime-local" id="editDueDate" name="due_date">
            </div>
            <div>
                <label>
                    <input type="checkbox" id="editCompleted" name="completed">
                    Completed
                </label>
            </div>
            <button type="button" onclick="updateEditForm()">Save Changes</button>
            <button type="button" onclick="closeEditModal()">Cancel</button>
        </form>
    </div>

    <script>
        function updateEditForm() {
            const id = document.getElementById('editId').value;
            const form = document.getElementById('editForm');
            
            // Build update payload
            const data = {
                title: document.getElementById('editTitle').value,
                description: document.getElementById('editDescription').value || null,
                priority: document.getElementById('editPriority').value,
                due_date: document.getElementById('editDueDate').value || null,
                completed: document.getElementById('editCompleted').checked
            };

            fetch(`http://localhost:8000/todos/${id}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    closeEditModal();
                    htmx.trigger('body', 'todoUpdated');
                } else {
                    alert('Failed to update todo');
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    </script>
</body>
</html>